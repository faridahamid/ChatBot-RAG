<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - RAG ChatBot</title>
  <link rel="stylesheet" href="/css/dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      line-height:1.6;color:#E9E7F1;
      background:
        radial-gradient(1200px 600px at 20% -10%,rgba(151,71,255,.35),transparent 60%),
        radial-gradient(1200px 800px at 110% 10%,rgba(82,0,204,.35),transparent 60%),
        linear-gradient(145deg,#0f0b17 0%,#1a1226 40%,#241437 100%);
      min-height:100vh;
      padding-top:72px; /* room for fixed navbar */
    }

    /* Navbar (text links like welcome page) */
    .navbar{
      background:rgba(24,16,37,.7);
      backdrop-filter:blur(12px);
      padding:1rem 2rem;
      position:fixed;top:0;left:0;right:0;z-index:1000;
      box-shadow:0 2px 14px rgba(0,0,0,.35);
    }
    .nav-container{
      max-width:1200px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
    }
    .logo-wrapper{display:flex;align-items:center;gap:10px}
    .logo-image{height:40px;width:40px;border-radius:50%;object-fit:cover;box-shadow:0 2px 6px rgba(0,0,0,.4)}
    .logo-text{font-size:1.4rem;font-weight:700;color:#B18CFF}
    .nav-links{display:flex;list-style:none;gap:2rem}
    .nav-links a{
      text-decoration:none;color:#E9E7F1;font-weight:600;
      transition:color .25s ease,opacity .25s ease;
      padding:.25rem 0;
    }
    .nav-links a:hover,.nav-links a.active{color:#B18CFF}

    /* Page shell */
    .container{max-width:1400px;margin:0 auto;padding:1.25rem 2rem 2rem}
    .header{
      text-align:center;margin-bottom:2rem;padding:2rem;
      background:rgba(255,255,255,.05);
      border-radius:15px;border:1px solid rgba(255,255,255,.1);
    }
    .welcome-message{
      font-size:2.5rem;margin-bottom:1.5rem;
      background:linear-gradient(135deg,#B18CFF,#8a2be2);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
    }
    .info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-top:1.5rem}
    .info-item{background:rgba(255,255,255,.08);padding:1rem;border-radius:10px;border:1px solid rgba(255,255,255,.1)}
    .info-label{color:#B18CFF;font-weight:600;margin-bottom:.5rem}
    .info-value{color:#fff;font-size:1.1rem}

    /* Admin nav cards */
    .admin-nav-section{margin-top:1rem;margin-bottom:3rem}
    .admin-nav-title{font-size:2rem;color:#B18CFF;text-align:center;margin-bottom:2rem}
    .admin-nav-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem}
    .admin-nav-card{
      background:rgba(255,255,255,.08);padding:2rem;border-radius:15px;
      border:1px solid rgba(255,255,255,.1);cursor:pointer;transition:all .3s ease;text-align:center;
    }
    .admin-nav-card:hover{background:rgba(255,255,255,.12);transform:translateY(-5px);box-shadow:0 10px 25px rgba(138,43,226,.3)}
    .admin-nav-card-icon{font-size:3rem;margin-bottom:1rem}
    .admin-nav-card-title{font-size:1.5rem;color:#E9E7F1;font-weight:600;margin-bottom:.5rem}
    .admin-nav-card-description{color:#c9c4d6;font-size:1rem}

    /* Messages (alerts) */
    .message{padding:1rem;border-radius:8px;margin:1rem 0;text-align:center;font-weight:500;display:none}
    .message.success{background:rgba(40,167,69,.2);color:#28a745;border:1px solid rgba(40,167,69,.3)}
    .message.error{background:rgba(220,53,69,.2);color:#dc3545;border:1px solid rgba(220,53,69,.3)}

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal {
      background: rgba(24, 16, 37, 0.95);
      border-radius: 15px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      border: 1px solid rgba(177, 140, 255, 0.3);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
    }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 1rem;
    }
    .modal-title { color: #B18CFF; font-size: 1.5rem; margin: 0; }
    .modal-close {
      background: none; border: none; color: #c9c4d6; font-size: 1.5rem; cursor: pointer; padding: 0;
      width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;
      transition: all 0.3s ease;
    }
    .modal-close:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; color: #B18CFF; font-weight: 600; }
    .form-group input {
      width: 100%; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px;
      background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 1rem; transition: all 0.3s ease;
    }
    .form-group input:focus { outline: none; border-color: #B18CFF; box-shadow: 0 0 0 2px rgba(177, 140, 255, 0.2); }

    .password-requirements {
      padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .password-requirements h4 { color: #B18CFF; font-size: 0.9rem; font-weight: 600; }
    .requirements-list { list-style: none; padding: 0; margin: 0; }
    .requirement { color: #f37e7e; font-size: 0.85rem; transition: color 0.3s ease; }
    .requirement.valid { color: #47d27e; }
    .error-message {
      color: #f37e7e; font-size: 0.85rem; margin-top: 0.5rem; padding: 0.5rem;
      background: rgba(220, 53, 69, 0.1); border-radius: 4px; border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; }
    .modal-btn { border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
    .modal-btn.secondary { background: rgba(255, 255, 255, 0.1); color: #c9c4d6; border: 1px solid rgba(255, 255, 255, 0.2); }
    .modal-btn.secondary:hover { background: rgba(255, 255, 255, 0.15); color: #fff; }
    .modal-btn.primary { background: linear-gradient(135deg, #8a2be2, #5b19a6); color: white; }
    .modal-btn.primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4); }
    .modal-btn.primary:disabled { background: rgba(255, 255, 255, 0.1); color: #666; cursor: not-allowed; opacity: 0.6; }

    @media (max-width:720px){.nav-links{gap:1rem;font-size:.95rem}}
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo-wrapper">
        <img src="https://i.pinimg.com/1200x/c4/dd/47/c4dd475a926160c734876937ce9aafe4.jpg" alt="RAG ChatBot" class="logo-image">
        <div class="logo-text">RAG ChatBot</div>
      </div>
      <ul class="nav-links">
        <li><a href="#" onclick="openChangePasswordModal()">Change Password</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="welcome-message">Admin Dashboard</h1>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Username:</div>
          <div class="info-value" id="adminUsername">Loading...</div>
        </div>
        <div class="info-item">
          <div class="info-label">Role:</div>
          <div class="info-value" id="adminRole">Admin</div>
        </div>
        <div class="info-item">
          <div class="info-label">Organization:</div>
          <div class="info-value" id="adminOrganization">Loading...</div>
        </div>
      </div>
    </div>

    <div id="message" class="message"></div>

    <!-- Admin navigation cards -->
    <div class="admin-nav-section" id="adminNavSection">
      <h2 class="admin-nav-title">Admin Functions</h2>
      <div class="admin-nav-grid">
        <div class="admin-nav-card" onclick="redirectToPage('admin-documents')">
          <div class="admin-nav-card-icon">ðŸ“„</div>
          <div class="admin-nav-card-title">Manage Documents</div>
          <div class="admin-nav-card-description">Upload, view, and manage organization documents</div>
        </div>
        <div class="admin-nav-card" onclick="redirectToPage('admin-users')">
          <div class="admin-nav-card-icon">ðŸ‘¥</div>
          <div class="admin-nav-card-title">Manage Users</div>
          <div class="admin-nav-card-description">Create and manage user accounts</div>
        </div>
        <div class="admin-nav-card" onclick="redirectToPage('admin-feedback')">
          <div class="admin-nav-card-icon">ðŸ’¬</div>
          <div class="admin-nav-card-title">View Feedback</div>
          <div class="admin-nav-card-description">Review user feedback and ratings</div>
        </div>
        <div class="admin-nav-card" onclick="redirectToPage('admin-chat')">
          <div class="admin-nav-card-icon">ðŸ¤–</div>
          <div class="admin-nav-card-title">Chat</div>
          <div class="admin-nav-card-description">Chat with AI assistant</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="changePasswordModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Change Password</h3>
        <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
      </div>
      <form class="modal-form" id="changePasswordForm">
        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" name="currentPassword" required placeholder="Enter current password" oninput="validatePassword()">
        </div>
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" name="newPassword" required placeholder="Enter new password" oninput="validatePassword()">

          <!-- Password Requirements -->
          <div class="password-requirements">
            <h4>Password Requirements:</h4>
            <ul class="requirements-list">
              <li id="req-length" class="requirement">âœ— Minimum 8 characters</li>
              <li id="req-uppercase" class="requirement">âœ— At least one uppercase letter</li>
              <li id="req-lowercase" class="requirement">âœ— At least one lowercase letter</li>
              <li id="req-number" class="requirement">âœ— At least one number</li>
              <li id="req-special" class="requirement">âœ— At least one special character</li>
            </ul>
          </div>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm new password" oninput="validatePassword()">
          <div id="password-match-error" class="error-message" style="display: none;">Passwords do not match</div>
        </div>
        <div id="password-error" class="error-message" style="display: none;"></div>
        <div class="modal-actions">
          <button type="button" class="modal-btn secondary" onclick="closeChangePasswordModal()">Cancel</button>
          <button type="submit" class="modal-btn primary" id="changePasswordBtn" disabled>Change Password</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', function(){
      loadUserInfo();

      // Submit handler with validation + redirect to welcome page on success
      const changePasswordForm = document.getElementById('changePasswordForm');
      changePasswordForm.addEventListener('submit', async function(e){
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const { canSubmit } = validatePassword();

        if (!currentPassword) { showMessage("Please enter your current password.", "error"); return; }
        if (!canSubmit) { showMessage("Please meet all password requirements and ensure both passwords match.", "error"); return; }
        if (!currentUser || !currentUser.id) { showMessage("Session expired. Please log in again.", "error"); return; }

        try{
          const fd = new FormData();
          fd.append("current_password", currentPassword);
          fd.append("new_password", newPassword);
          fd.append("user_id", currentUser.id);

          const res = await fetch("/change-password", { method: "POST", body: fd });
          const data = await res.json();
          if (res.ok){
            closeChangePasswordModal();
            // Log out current session to avoid stale creds, then redirect home
            sessionStorage.removeItem("user");
            showMessage("Password changed successfully! Redirectingâ€¦", "success");
            setTimeout(()=>{ window.location.href = "/"; }, 1500);
          } else {
            showMessage(data.detail || "Failed to change password", "error");
          }
        } catch(err){
          console.error("Change password error:", err);
          showMessage("Error changing password. Please try again.", "error");
        }
      });

      // click outside to close modal
      const modalOverlay = document.getElementById('changePasswordModal');
      modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) closeChangePasswordModal();
      });
    });

    function loadUserInfo(){
      const userStr = sessionStorage.getItem("user");
      if (!userStr){
        showMessage("No user information found. Please log in again.", "error");
        setTimeout(()=>location.href="/login", 1500);
        return;
      }
      try{
        currentUser = JSON.parse(userStr);
        if ((currentUser.role||"").toLowerCase() !== "admin"){
          location.href="/dashboard"; return;
        }
        document.getElementById("adminUsername").textContent = currentUser.username || "N/A";
        document.getElementById("adminRole").textContent = currentUser.role || "N/A";
        document.getElementById("adminOrganization").textContent = currentUser.organization_name || "N/A";
      }catch(e){
        console.error("Error parsing user:", e);
        showMessage("Error loading user information.", "error");
      }
    }

    function redirectToPage(page){ location.href = `/${page}`; }

    function showMessage(text, type){
      const el = document.getElementById("message");
      el.textContent = text;
      el.className = `message ${type}`;
      el.style.display = "block";
      if (type === "success"){ setTimeout(()=> el.style.display="none", 3000); }
    }

    // Password validation function (live)
    function validatePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      const passwordError = document.getElementById('password-error');
      const passwordMatchError = document.getElementById('password-match-error');

      // Password requirements
      const requirements = {
        length: newPassword.length >= 8,
        uppercase: /[A-Z]/.test(newPassword),
        lowercase: /[a-z]/.test(newPassword),
        number: /\d/.test(newPassword),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(newPassword)
      };

      // Update visual indicators
      document.getElementById('req-length').className = requirements.length ? 'requirement valid' : 'requirement';
      document.getElementById('req-length').innerHTML = requirements.length ? 'âœ“ Minimum 8 characters' : 'âœ— Minimum 8 characters';

      document.getElementById('req-uppercase').className = requirements.uppercase ? 'requirement valid' : 'requirement';
      document.getElementById('req-uppercase').innerHTML = requirements.uppercase ? 'âœ“ At least one uppercase letter' : 'âœ— At least one uppercase letter';

      document.getElementById('req-lowercase').className = requirements.lowercase ? 'requirement valid' : 'requirement';
      document.getElementById('req-lowercase').innerHTML = requirements.lowercase ? 'âœ“ At least one lowercase letter' : 'âœ— At least one lowercase letter';

      document.getElementById('req-number').className = requirements.number ? 'requirement valid' : 'requirement';
      document.getElementById('req-number').innerHTML = requirements.number ? 'âœ“ At least one number' : 'âœ— At least one number';

      document.getElementById('req-special').className = requirements.special ? 'requirement valid' : 'requirement';
      document.getElementById('req-special').innerHTML = requirements.special ? 'âœ“ At least one special character' : 'âœ— At least one special character';

      // Check if all requirements are met
      const allRequirementsMet = Object.values(requirements).every(req => req);

      // Check password confirmation
      const passwordsMatch = newPassword === confirmPassword && confirmPassword.length > 0;

      // Show/hide password match error
      if (confirmPassword.length > 0 && !passwordsMatch) {
        passwordMatchError.style.display = 'block';
      } else {
        passwordMatchError.style.display = 'none';
      }

      // Enable/disable submit button
      const canSubmit = allRequirementsMet && passwordsMatch && document.getElementById('currentPassword').value.length > 0;
      changePasswordBtn.disabled = !canSubmit;

      // Clear any previous error messages
      passwordError.style.display = 'none';

      return { allRequirementsMet, passwordsMatch, canSubmit };
    }

    function openChangePasswordModal(){
      document.getElementById('changePasswordModal').classList.add('active');
      setTimeout(()=>document.getElementById('currentPassword').focus(), 50);
    }
    function closeChangePasswordModal(){
      document.getElementById('changePasswordModal').classList.remove('active');
      document.getElementById('changePasswordForm').reset();
      // Reset UI state
      document.getElementById('changePasswordBtn').disabled = true;
      document.getElementById('password-match-error').style.display = 'none';
      document.getElementById('req-length').className = 'requirement';
      document.getElementById('req-uppercase').className = 'requirement';
      document.getElementById('req-lowercase').className = 'requirement';
      document.getElementById('req-number').className = 'requirement';
      document.getElementById('req-special').className = 'requirement';
      document.getElementById('req-length').innerHTML = 'âœ— Minimum 8 characters';
      document.getElementById('req-uppercase').innerHTML = 'âœ— At least one uppercase letter';
      document.getElementById('req-lowercase').innerHTML = 'âœ— At least one lowercase letter';
      document.getElementById('req-number').innerHTML = 'âœ— At least one number';
      document.getElementById('req-special').innerHTML = 'âœ— At least one special character';
    }

    function logout(){
      sessionStorage.removeItem("user");
      location.href = "/";
    }
  </script>
</body>
</html>
