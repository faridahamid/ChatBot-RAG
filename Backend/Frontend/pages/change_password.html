<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Change Password</title>

  <!-- Optional: reuse your dashboard CSS to keep the same look -->
  <link rel="stylesheet" href="/css/dashboard.css">

  <style>
    html,body{height:100%;margin:0;font-family:Segoe UI,Tahoma,Arial,sans-serif;background:#0f0b17;color:#E9E7F1}
    .wrap{
      min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px;
      background:
        radial-gradient(1200px 600px at 20% -10%,rgba(151,71,255,.35),transparent 60%),
        radial-gradient(1200px 800px at 110% 10%,rgba(82,0,204,.35),transparent 60%),
        linear-gradient(145deg,#0f0b17 0%,#1a1226 40%,#241437 100%);
    }
    .card{
      width:min(520px,92vw);background:rgba(24,16,37,.95);
      border:1px solid rgba(177,140,255,.3);border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,.5);padding:2rem;
    }
    h1{color:#B18CFF;font-size:1.5rem;margin:0 0 1rem}
    .hint{color:#c9c4d6;font-size:.9rem;margin:-.5rem 0 1rem}
    .form-group{margin-bottom:1rem}
    .form-group label{display:block;color:#B18CFF;font-weight:600;margin-bottom:.4rem}
    .form-group input{
      width:100%;padding:.75rem;border:1px solid rgba(255,255,255,.2);
      border-radius:8px;background:rgba(255,255,255,.1);color:#fff;font-size:1rem;
      transition:all .3s ease;
    }
    .form-group input:focus{outline:none;border-color:#B18CFF;box-shadow:0 0 0 2px rgba(177,140,255,.2)}
    .password-requirements{
      padding:1rem;background:rgba(255,255,255,.05);border-radius:8px;border:1px solid rgba(255,255,255,.1);margin-top:.6rem
    }
    .password-requirements h4{color:#B18CFF;font-size:.9rem;margin:0 0 .5rem;font-weight:600}
    .requirements-list{list-style:none;padding:0;margin:0}
    .requirement{color:#f37e7e;font-size:.85rem;transition:color .3s ease}
    .requirement.valid{color:#47d27e}
    .error-message{
      color:#f37e7e;font-size:.85rem;margin-top:.5rem;padding:.5rem;
      background:rgba(220,53,69,.1);border-radius:4px;border:1px solid rgba(220,53,69,.2)
    }
    .msg{display:none;margin-top:10px;padding:10px;border-radius:8px;text-align:center;font-weight:600}
    .msg.ok{display:block;background:rgba(40,167,69,.2);color:#28a745;border:1px solid rgba(40,167,69,.3)}
    .msg.err{display:block;background:rgba(220,53,69,.2);color:#dc3545;border:1px solid rgba(220,53,69,.3)}
    .actions{display:flex;gap:1rem;justify-content:flex-end;margin-top:1rem}
    .btn{padding:.75rem 1.25rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .2s ease;font-size:.95rem}
    .btn.secondary{background:rgba(255,255,255,.1);color:#c9c4d6;border:1px solid rgba(255,255,255,.2)}
    .btn.secondary:hover{background:rgba(255,255,255,.15);color:#fff}
    .btn.primary{background:linear-gradient(135deg,#8a2be2,#5b19a6);color:#fff}
    .btn.primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 12px rgba(138,43,226,.4)}
    .btn.primary:disabled{background:rgba(255,255,255,.1);color:#666;cursor:not-allowed;opacity:.6}
    .meta{margin-top:8px;color:#c9c4d6;font-size:12px}
    a.link{color:#B18CFF;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Change Password</h1>
      <div class="hint">Enter your current (temporary) password and choose a strong new one.</div>

      <form id="changePasswordForm" novalidate>
        <!-- user_id comes from ?user_id=... -->
        <input type="hidden" id="userId"/>

        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" name="currentPassword" required placeholder="Enter current password" oninput="validatePassword()"/>
        </div>

        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" name="newPassword" required placeholder="Enter new password" oninput="validatePassword()"/>
          <!-- Requirements -->
          <div class="password-requirements">
            <h4>Password Requirements:</h4>
            <ul class="requirements-list">
              <li id="req-length"   class="requirement">✗ Minimum 8 characters</li>
              <li id="req-uppercase" class="requirement">✗ At least one uppercase letter</li>
              <li id="req-lowercase" class="requirement">✗ At least one lowercase letter</li>
              <li id="req-number"    class="requirement">✗ At least one number</li>
              <li id="req-special"   class="requirement">✗ At least one special character</li>
            </ul>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm new password" oninput="validatePassword()"/>
          <div id="password-match-error" class="error-message" style="display:none;">Passwords do not match</div>
        </div>

        <div id="password-error" class="error-message" style="display:none;"></div>

        <div class="actions">
          <a class="link" href="/" style="align-self:center">Back to Welcome</a>
          <button type="submit" class="btn primary" id="changePasswordBtn" disabled>Change Password</button>
        </div>

        <div id="msg" class="msg"></div>
        <div class="meta" id="uidMeta"></div>
      </form>
    </div>
  </div>

  <script>
    // ===== Password validation function (your logic) =====
    function validatePassword() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      const passwordError = document.getElementById('password-error');
      const passwordMatchError = document.getElementById('password-match-error');

      const requirements = {
        length: newPassword.length >= 8,
        uppercase: /[A-Z]/.test(newPassword),
        lowercase: /[a-z]/.test(newPassword),
        number: /\d/.test(newPassword),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(newPassword)
      };

      document.getElementById('req-length').className = requirements.length ? 'requirement valid' : 'requirement';
      document.getElementById('req-length').innerHTML = requirements.length ? '✓ Minimum 8 characters' : '✗ Minimum 8 characters';

      document.getElementById('req-uppercase').className = requirements.uppercase ? 'requirement valid' : 'requirement';
      document.getElementById('req-uppercase').innerHTML = requirements.uppercase ? '✓ At least one uppercase letter' : '✗ At least one uppercase letter';

      document.getElementById('req-lowercase').className = requirements.lowercase ? 'requirement valid' : 'requirement';
      document.getElementById('req-lowercase').innerHTML = requirements.lowercase ? '✓ At least one lowercase letter' : '✗ At least one lowercase letter';

      document.getElementById('req-number').className = requirements.number ? 'requirement valid' : 'requirement';
      document.getElementById('req-number').innerHTML = requirements.number ? '✓ At least one number' : '✗ At least one number';

      document.getElementById('req-special').className = requirements.special ? 'requirement valid' : 'requirement';
      document.getElementById('req-special').innerHTML = requirements.special ? '✓ At least one special character' : '✗ At least one special character';

      const allRequirementsMet = Object.values(requirements).every(req => req);
      const passwordsMatch = newPassword === confirmPassword && confirmPassword.length > 0;

      if (confirmPassword.length > 0 && !passwordsMatch) {
        passwordMatchError.style.display = 'block';
      } else {
        passwordMatchError.style.display = 'none';
      }

      const canSubmit = allRequirementsMet && passwordsMatch && document.getElementById('currentPassword').value.length > 0;
      changePasswordBtn.disabled = !canSubmit;

      passwordError.style.display = 'none';
      return { allRequirementsMet, passwordsMatch, canSubmit };
    }

    // ===== Helpers & Submit =====
    const $ = (s) => document.querySelector(s);
    const msg = $("#msg");

    function showMsg(text, ok) {
      msg.textContent = text;
      msg.className = "msg " + (ok ? "ok" : "err");
    }

    function getQueryParam(name) {
      const p = new URLSearchParams(location.search);
      return p.get(name) || "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Inject user_id from URL
      const uid = getQueryParam("user_id");
      $("#userId").value = uid;
      $("#uidMeta").textContent = uid ? "User ID: " + (uid.length > 8 ? uid.slice(0,8) + "…" : uid) : "Missing user id in URL.";

      // Submit
      $("#changePasswordForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const userId = $("#userId").value.trim();
        const currentPassword = $("#currentPassword").value.trim();
        const newPassword = $("#newPassword").value.trim();
        const confirmPassword = $("#confirmPassword").value.trim();

        const { canSubmit } = validatePassword();
        if (!userId) { showMsg("Missing user id. Please use the link from your email again.", false); return; }
        if (!canSubmit) { showMsg("Please meet all password requirements.", false); return; }

        try {
          const fd = new FormData();
          fd.append("current_password", currentPassword);
          fd.append("new_password", newPassword);
          fd.append("user_id", userId);

          const res = await fetch("/change-password", { method: "POST", body: fd });
          const data = await res.json();

          if (res.ok) {
            const redirect = data.redirect || "/";
            showMsg("Password changed successfully. Redirecting…", true);
            setTimeout(() => window.location.href = redirect, 1200);
          } else {
            showMsg(data.detail || "Failed to change password.", false);
          }
        } catch (err) {
          console.error(err);
          showMsg("Error changing password. Please try again.", false);
        }
      });
    });
  </script>
</body>
</html>
