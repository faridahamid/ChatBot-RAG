<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - RAG ChatBot</title>
    <link rel="stylesheet" href="/css/dashboard.css">
<style>
       .nav-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-actions a {
        text-decoration: none;
        color: #E9E7F1;
        font-weight: 500;
        transition: color 0.3s ease;
        padding: 0.5rem 1rem;
        border-radius: 8px;
      }

      .nav-actions a:hover {
        color: #B18CFF;
        background: rgba(177, 140, 255, 0.1);
        transform: translateY(-1px);
      }
      
      .nav-actions a.admin-btn:hover {
        background: rgba(177, 140, 255, 0.2);
        border-color: rgba(177, 140, 255, 0.5);
      }
      
      .nav-actions a.logout-btn:hover {
        background: rgba(220, 53, 69, 0.2);
        border-color: rgba(220, 53, 69, 0.5);
      }

      .nav-actions a.admin-btn {
        background: rgba(177, 140, 255, 0.1);
        border: 1px solid rgba(177, 140, 255, 0.3);
        color: #B18CFF;
      }

      .nav-actions a.logout-btn {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
        color: #f37e7e;
      }
      
      .nav-actions a.logout-btn:hover {
        background: rgba(220, 53, 69, 0.2);
        border-color: rgba(220, 53, 69, 0.5);
      } */

      /* Main Container */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 100px 2rem 2rem 2rem;
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 2rem;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .welcome-message {
        font-size: 2.5rem;
        color: #fff;
        margin-bottom: 1.5rem;
        background: linear-gradient(135deg, #B18CFF, #8a2be2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .info-item {
        background: rgba(255, 255, 255, 0.08);
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .info-label {
        color: #B18CFF;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }

      .info-value {
        color: #fff;
        font-size: 1.1rem;
      }

      /* Chat Section */
      .chat-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .chat-header h2 {
        color: #fff;
        font-size: 1.8rem;
      }

      .new-chat-btn {
        background: linear-gradient(135deg, #8a2be2, #5b19a6);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .new-chat-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(138, 43, 226, 0.4);
      }

      .chat-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        margin-left: 320px;
        margin-top: 0;
      }

      .chat-history {
        background: transparent;
        border-radius: 12px;
        padding: 1.5rem;
        border: none;
        max-height: 500px;
        overflow-y: auto;
        position: fixed;
        top: 120px;
        left: 2rem;
        width: 280px;
        z-index: 100;
      }

      .chat-history::-webkit-scrollbar {
        width: 6px;
      }

      .chat-history::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .chat-history::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .chat-history h4 {
        color: #B18CFF;
        margin-bottom: 1rem;
        font-size: 1.2rem;
        position: fixed;
        top: 80px;
        left: 2rem;
        z-index: 10;
        background: transparent;
        padding: 0;
        font-weight: 600;
        width: 280px;
      }

      .chat-item {
        background: rgba(255, 255, 255, 0.03);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .chat-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .chat-item.active {
        background: rgba(177, 140, 255, 0.15);
        border-color: #B18CFF;
        box-shadow: 0 4px 12px rgba(177, 140, 255, 0.3);
      }

      .chat-title {
        color: #fff;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .chat-meta {
        color: #c9c4d6;
        font-size: 0.9rem;
      }

      .chat-container {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
      }

      .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 1.5rem;
      }

      .chat-messages::-webkit-scrollbar {
        width: 6px;
      }

      .chat-messages::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
      }

      .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }

      .message-bubble {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 12px;
        max-width: 80%;
        position: relative;
      }

      .message-bubble.user {
        background: linear-gradient(135deg, #8a2be2, #5b19a6);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }

      .message-bubble.assistant {
        background: rgba(255, 255, 255, 0.1);
        color: #E9E7F1;
        margin-right: auto;
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .timestamp {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.5rem;
      }

      .chat-input-container {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .chat-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1rem;
      }

      .chat-input::placeholder {
        color: #c9c4d6;
      }

      .chat-input:focus {
        outline: none;
        border-color: #B18CFF;
        box-shadow: 0 0 0 2px rgba(177, 140, 255, 0.2);
      }

      .mic-btn, .send-btn {
        background: linear-gradient(135deg, #8a2be2, #5b19a6);
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .mic-btn:hover, .send-btn:hover {
        transform: scale(1.1);
      }

      .mic-btn.recording {
        background: linear-gradient(135deg, #dc3545, #c82333);
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }

      /* Message Styles */
      .message {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 500;
      }

      .message.success {
        background: rgba(40, 167, 69, 0.2);
        color: #47d27e;
        border: 1px solid rgba(40, 167, 69, 0.3);
      }

      .message.error {
        background: rgba(220, 53, 69, 0.2);
        color: #f37e7e;
        border: 1px solid rgba(220, 53, 69, 0.3);
      }

      /* Feedback Section */
      .feedback-section {
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.3s ease;
      }
      
      .feedback-section:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      
      .feedback-toggle-btn {
        background: rgba(177, 140, 255, 0.1);
        color: #B18CFF;
        border: 1px solid rgba(177, 140, 255, 0.3);
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      .feedback-toggle-btn:hover {
        background: rgba(177, 140, 255, 0.2);
        border-color: rgba(177, 140, 255, 0.5);
        transform: translateY(-1px);
      }
      
      .feedback-form {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        animation: slideDown 0.3s ease-out;
      }
      
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .feedback-form .row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }
      
      .feedback-form label {
        font-weight: 600;
        color: #B18CFF;
        min-width: 80px;
        font-size: 0.9em;
      }
      
      .star-rating {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      
      .star {
        font-size: 1.5rem;
        cursor: pointer;
        color: #8a7f9a;
        transition: color 0.2s ease;
      }
      
      .star:hover {
        color: #FFD700;
      }
      
      .star.filled {
        color: #FFD700;
      }
      
      .feedback-form textarea {
        width: 100%;
        min-height: 80px;
        padding: 12px;
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        resize: vertical;
        font-family: inherit;
        font-size: 0.9em;
        color: #E9E7F1;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.05);
      }
      
      .feedback-form textarea:focus {
        outline: none;
        border-color: #B18CFF;
        box-shadow: 0 0 0 3px rgba(177, 140, 255, 0.2);
        background: rgba(255, 255, 255, 0.08);
      }
      
      .feedback-form textarea::placeholder {
        color: #c9c4d6;
        font-style: italic;
      }
      
      .feedback-form .actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
      }
      
      .feedback-submit-btn {
        background: rgba(177, 140, 255, 0.1);
        color: #B18CFF;
        border: 1px solid rgba(177, 140, 255, 0.3);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      .feedback-submit-btn:hover {
        background: rgba(177, 140, 255, 0.2);
        border-color: rgba(177, 140, 255, 0.5);
        transform: translateY(-1px);
      }
      
      .feedback-cancel-btn {
        background: rgba(255, 255, 255, 0.1);
        color: #c9c4d6;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
      }
      
      .feedback-cancel-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .chat-layout {
          grid-template-columns: 1fr;
          margin-left: 0;
        }
        
        .nav-actions {
          flex-wrap: wrap;
          gap: 0.5rem;
        }
        
        .nav-actions a {
          font-size: 0.8rem;
          padding: 0.4rem 0.8rem;
        }
        
        .container {
          padding: 80px 1rem 1rem 1rem;
        }
        
        .chat-history {
          position: relative;
          top: auto;
          left: auto;
          width: 100%;
          margin-bottom: 2rem;
        }
        
        .chat-history h4 {
          position: relative;
          top: auto;
          left: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo-wrapper">
          <img src="https://i.pinimg.com/1200x/c4/dd/47/c4dd475a926160c734876937ce9aafe4.jpg" 
               alt="RAG ChatBot" class="logo-image">
          <div class="logo-text">RAG ChatBot</div>
        </div>
                 <div class="nav-actions">
           <a href="#" onclick="openChangePasswordModal()">Password</a>
           <!-- Admin Navigation Items -->
           <a href="/admin-upload" class="admin-nav-item" style="display: none">Upload Files</a>
           <a href="/admin-users" class="admin-nav-item" style="display: none">Users</a>
           <a href="/admin-documents" class="admin-nav-item" style="display: none">Documents</a>
           <a href="/admin-feedback" class="admin-nav-item" style="display: none">Feedback</a>
           <a href="#" onclick="logout()" class="logout-btn">Logout</a>
         </div>
      </div>
    </nav>

    <div class="container">
      <div class="header">
        <h1 class="welcome-message">Welcome to Your Dashboard</h1>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Username:</div>
            <div class="info-value" id="username">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Role:</div>
            <div class="info-value" id="role">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Organization:</div>
            <div class="info-value" id="organization">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">User ID:</div>
            <div class="info-value" id="userid">Loading...</div>
          </div>
        </div>
      </div>

      <div id="message" class="message" style="display: none"></div>

      <!-- Chat Interface for Users -->
      <div class="chat-section" id="chatSection">
        <div class="chat-header">
          <h2>Chat with AI Assistant</h2>
          <button class="new-chat-btn" onclick="createNewChat()">
            New Chat
          </button>
        </div>
        <p style="text-align: center; margin-bottom: 1rem; opacity: 0.8">
          Ask questions about your organization's documents and get intelligent answers
        </p>
        
        <div class="chat-layout">
          <div class="chat-history" id="chatHistory" style="display: none;">
            <h4>Your Chats</h4>
            <div id="chatHistoryList"></div>
          </div>

          <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
              <div class="message-bubble assistant">
                <div>
                  Hello! I'm your AI assistant. I can help you find information
                  from your organization's documents. What would you like to know?
                </div>
                <div class="timestamp">Just now</div>
              </div>
            </div>
            <div class="chat-input-container">
              <input
                type="text"
                class="chat-input"
                id="chatInput"
                placeholder="Type your question here..."
                onkeypress="handleKeyPress(event)"
              />
              <button class="mic-btn" id="micBtn" title="Record voice" aria-label="Record voice" onclick="toggleRecording()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M12 3a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V6a3 3 0 0 0-3-3z"></path>
                  <path d="M19 10a7 7 0 0 1-14 0"></path>
                  <path d="M12 17v4"></path>
                  <path d="M9 21h6"></path>
                </svg>
              </button>
              <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    
  </div>

  <!-- Change Password Modal -->
  <div class="modal-overlay" id="changePasswordModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Change Password</h3>
        <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
      </div>
      <form class="modal-form" id="changePasswordForm">
        <div class="form-group">
          <label for="currentPassword">Current Password</label>
          <input type="password" id="currentPassword" name="currentPassword" required placeholder="Enter current password">
        </div>
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" name="newPassword" required placeholder="Enter new password">
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm New Password</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm new password">
        </div>
        <div class="modal-actions">
          <button type="button" class="modal-btn secondary" onclick="closeChangePasswordModal()">Cancel</button>
          <button type="submit" class="modal-btn primary">Change Password</button>
        </div>
      </form>
    </div>
  </div>

  <script>
      
      let currentChatId = null;
      let user = null;

      
      function loadUserInfo() {
        const userStr = sessionStorage.getItem("user");
        if (userStr) {
          try {
            user = JSON.parse(userStr);
            
            
            if (user.role === "super-admin") {
              window.location.href = "/super-admin";
              return;
            }
            
            document.getElementById("username").textContent =
              user.username || "N/A";
            document.getElementById("role").textContent = user.role || "N/A";
            document.getElementById("organization").textContent =
              user.organization_name || "N/A";
            document.getElementById("userid").textContent = user.id || "N/A";

          
            if (user.role === "admin") {
              // Show admin navigation items
              const adminNavItems = document.querySelectorAll('.admin-nav-item');
              adminNavItems.forEach(item => item.style.display = 'inline-block');
              
              document.getElementById("chatSection").style.display = "block";
              document.getElementById("chatHistory").style.display = "block";
              loadChatHistory();
              
              // Auto-create a new chat for admin
              setTimeout(() => createNewChat(), 500);
            } else {
              
              document.getElementById("chatSection").style.display = "block";
              document.getElementById("chatHistory").style.display = "block";
              
              loadChatHistory();
              
              // Auto-create a new chat for regular users
              setTimeout(() => createNewChat(), 500);
            }

            // Removed welcome message
          } catch (error) {
            console.error("Error parsing user data:", error);
            showMessage("Error loading user information.", "error");
          }
        } else {
          showMessage(
            "No user information found. Please log in again.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "/login";
          }, 2000);
        }
      }

      
      async function createNewChat() {
        if (!user) {
          showMessage("User not found. Please log in again.", "error");
          return;
        }

        try {
          const response = await fetch("/chats", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: user.id,
            }),
          });

          if (response.ok) {
            const chatData = await response.json();
            currentChatId = chatData.chat_id;
            
            
            clearChatMessages();
            
            // Add welcome message
            addMessage(
              "Hello! I'm your AI assistant. I can help you find information from your organization's documents. What would you like to know?",
              "assistant"
            );
            
            
            loadChatHistory();
            
          } else {
            const error = await response.json();
            showMessage(`Error creating chat: ${error.detail}`, "error");
          }
        } catch (error) {
          console.error("Error creating new chat:", error);
          showMessage("Error creating new chat.", "error");
        }
      }

      async function loadChatHistory() {
        if (!user) return;

        try {
          const response = await fetch(`/chats/${user.id}`);
          if (response.ok) {
            const chats = await response.json();
            displayChatHistory(chats);
          }
        } catch (error) {
          console.error("Error loading chat history:", error);
        }
      }

      function displayChatHistory(chats) {
        const chatHistory = document.getElementById("chatHistory");
        const chatHistoryList = document.getElementById("chatHistoryList");
        
        chatHistory.style.display = "block";
        chatHistoryList.innerHTML = "";

        if (chats.length === 0) {
          const empty = document.createElement("div");
          empty.className = "chat-item";
          empty.textContent = "No chats yet";
          chatHistoryList.appendChild(empty);
          return;
        }

        chats.forEach(chat => {
          const chatItem = document.createElement("div");
          chatItem.className = `chat-item ${chat.chat_id === currentChatId ? 'active' : ''}`;
          
          let clickTimeout;
          chatItem.onclick = () => {
            clearTimeout(clickTimeout);
            clickTimeout = setTimeout(() => {
              loadChat(chat.chat_id);
            }, 200);
          };
          
          chatItem.ondblclick = (e) => {
            e.preventDefault();
            clearTimeout(clickTimeout);
            enableRename(chat.chat_id, chat.title);
          };
          
          const title = chat.title || "New Chat";
          const date = new Date(chat.created_at).toLocaleDateString();
          const messageCount = chat.message_count || 0;
          
          chatItem.innerHTML = `
            <div class="chat-title" data-id="${chat.chat_id}">${title}</div>
            <div class="chat-meta">${date} â€¢ ${messageCount} messages</div>
          `;
          
          chatHistoryList.appendChild(chatItem);
        });
      }

      async function loadChat(chatId) {
        if (!user) return;

        try {
          const response = await fetch(`/chats/${chatId}/messages`);
          if (response.ok) {
            const messages = await response.json();
            currentChatId = chatId;
            
            
            clearChatMessages();
            
            
            messages.forEach(msg => {
              addMessage(msg.content, msg.role, new Date(msg.created_at), msg.id);
            });
            
            
            loadChatHistory();
            
            requestAnimationFrame(() => {
              const chatMessages = document.getElementById("chatMessages");
              if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            });
          }
        } catch (error) {
          console.error("Error loading chat:", error);
          showMessage("Error loading chat.", "error");
        }
      }

      function clearChatMessages() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
      }

      
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      function addMessage(content, role, timestamp = new Date(), messageId = null) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message-bubble ${role}`;
        if (messageId) {
          messageDiv.setAttribute("data-message-id", messageId);
        }

        const timeStr = timestamp.toLocaleTimeString();
        
        // Add feedback section for assistant messages
        let feedbackSection = '';
        if (role === 'assistant' && messageId) {
          feedbackSection = `
            <div class="feedback-section">
              <button class="feedback-toggle-btn" onclick="toggleFeedbackForm('${messageId}')">ðŸ’¬ Give feedback</button>
              <div class="feedback-form" id="feedback-form-${messageId}">
                <div class="row">
                  <label>Rating:</label>
                  <div class="star-rating" id="star-rating-${messageId}">
                    <span class="star" data-rating="1" onclick="rateMessage('${messageId}', 1)">â˜…</span>
                    <span class="star" data-rating="2" onclick="rateMessage('${messageId}', 2)">â˜…</span>
                    <span class="star" data-rating="3" onclick="rateMessage('${messageId}', 3)">â˜…</span>
                    <span class="star" data-rating="4" onclick="rateMessage('${messageId}', 4)">â˜…</span>
                    <span class="star" data-rating="5" onclick="rateMessage('${messageId}', 5)">â˜…</span>
                  </div>
                </div>
                <div class="row">
                  <label>Comment (optional):</label>
                  <textarea id="comment-${messageId}" placeholder="Write a comment (optional)"></textarea>
                </div>
                <div class="actions">
                  <button class="feedback-submit-btn" onclick="submitInlineFeedback('${messageId}')">Submit</button>
                  <button class="feedback-cancel-btn" onclick="toggleFeedbackForm('${messageId}')">Cancel</button>
                </div>
              </div>
            </div>
          `;
        }
        
        messageDiv.innerHTML = `
          <div>${content}</div>
          <div class="timestamp">${timeStr}</div>
          ${feedbackSection}
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      
      async function enableRename(chatId, currentTitle) {
        const newTitle = prompt("Rename chat:", currentTitle || "");
        if (newTitle === null) return; // User cancelled
        
        const t = newTitle.trim();
        if (!t) {
          showMessage("Chat title cannot be empty.", "error");
          return;
        }
        
        if (t.length > 100) {
          showMessage("Chat title is too long. Please use 100 characters or less.", "error");
          return;
        }
        
        try {
          const res = await fetch(`/chats/${chatId}/title`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: user.id, title: t })
          });
          
          if (res.ok) {
            showMessage("Chat renamed successfully!", "success");
            loadChatHistory();
          } else {
            const err = await res.json();
            showMessage(`Rename failed: ${err.detail || 'Unknown error'}`, 'error');
          }
        } catch (e) {
          console.error('Rename error', e);
          showMessage('Rename failed. Please try again.', 'error');
        }
      }

      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendBtn");
        const question = input.value.trim();

        if (!question) return;

        if (!user) {
          showMessage("Session expired. Please log in again.", "error");
          return;
        }

        const orgId = user.organization_id;
        const userId = user.id;

        if (!orgId || !userId) {
          showMessage(
            "Missing user information. Please log in again.",
            "error"
          );
          return;
        }

        
        addMessage(question, "user");

        
        input.value = "";
        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading-indicator";
        loadingDiv.textContent = "AI is thinking...";
        document.getElementById("chatMessages").appendChild(loadingDiv);

        try {
          const requestBody = {
            org_id: orgId,
            user_id: userId,
            question: question,
          };

          
          if (currentChatId) {
            requestBody.chat_id = currentChatId;
          }

          const response = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          const data = await response.json();

         
          loadingDiv.remove();

          if (response.ok) {
            // After sending, reload the chat to get server-generated message IDs
            if (currentChatId) {
              await loadChat(currentChatId);
            } else {
              // If a chat wasn't set, history will update with a new chat; reload history
              loadChatHistory();
            }
          } else {
            addMessage(
              `Error: ${data.detail || "Failed to get response"}`,
              "assistant"
            );
          }
        } catch (error) {
          console.error("Error sending message:", error);
          loadingDiv.remove();
          addMessage(
            "Sorry, I encountered an error. Please try again.",
            "assistant"
          );
        } finally {
          
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
        }
      }

     
      let isRecording = false;
      let audioContext = null;
      let mediaStream = null;
      let sourceNode = null;
      let processorNode = null;
      let recordedBuffers = [];
      let recordingLength = 0;
      let recordingSampleRate = 16000; 

      async function toggleRecording() {
        const btn = document.getElementById("micBtn");
        if (!isRecording) {
          await startRecording();
          btn.classList.add("recording");
        } else {
          const wavBlob = await stopRecording();
          btn.classList.remove("recording");
          if (wavBlob) {
            await sendToStt(wavBlob);
          }
        }
      }

      async function startRecording() {
        recordedBuffers = [];
        recordingLength = 0;

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaStream = stream;
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        sourceNode = audioContext.createMediaStreamSource(stream);
        
        const bufferSize = 4096;
        processorNode = audioContext.createScriptProcessor(bufferSize, 1, 1);
        recordingSampleRate = audioContext.sampleRate || 44100;
        processorNode.onaudioprocess = (e) => {
          const input = e.inputBuffer.getChannelData(0);
          recordedBuffers.push(new Float32Array(input));
          recordingLength += input.length;
        };
        sourceNode.connect(processorNode);
        processorNode.connect(audioContext.destination);
        isRecording = true;
      }

      async function stopRecording() {
        if (!isRecording) return null;
        isRecording = false;
        try {
          if (processorNode) processorNode.disconnect();
          if (sourceNode) sourceNode.disconnect();
          if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
          if (audioContext && audioContext.state !== "closed") await audioContext.close();
        } catch (e) {
          console.warn("Cleanup error:", e);
        }

        const pcm = mergeBuffers(recordedBuffers, recordingLength);
      
        const pcm16k = resampleLinear(pcm, recordingSampleRate, 16000);
        const wavBlob = encodeWAV(pcm16k, 16000);
        return wavBlob;
      }

      function mergeBuffers(bufferArray, totalLength) {
        const result = new Float32Array(totalLength);
        let offset = 0;
        for (let i = 0; i < bufferArray.length; i++) {
          result.set(bufferArray[i], offset);
          offset += bufferArray[i].length;
        }
        return result;
      }

      function resampleLinear(input, inRate, outRate) {
        if (inRate === outRate) return input;
        const ratio = outRate / inRate;
        const newLength = Math.round(input.length * ratio);
        const output = new Float32Array(newLength);
        for (let i = 0; i < newLength; i++) {
          const pos = i / ratio;
          const idx = Math.floor(pos);
          const frac = pos - idx;
          const v0 = input[idx] || 0;
          const v1 = input[idx + 1] || v0;
          output[i] = v0 + (v1 - v0) * frac;
        }
        return output;
      }

      function encodeWAV(samples, sampleRate) {
    
        const bytesPerSample = 2;
        const blockAlign = 1 * bytesPerSample;
        const byteRate = sampleRate * blockAlign;
        const dataSize = samples.length * bytesPerSample;
        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);

       
        writeString(view, 0, "RIFF");
        view.setUint32(4, 36 + dataSize, true);
        writeString(view, 8, "WAVE");

        
        writeString(view, 12, "fmt ");
        view.setUint32(16, 16, true); 
        view.setUint16(20, 1, true);  
        view.setUint16(22, 1, true);  
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, 16, true); 

        
        writeString(view, 36, "data");
        view.setUint32(40, dataSize, true);

       
        floatTo16BitPCM(view, 44, samples);

        return new Blob([view], { type: "audio/wav" });
      }

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      function floatTo16BitPCM(view, offset, input) {
        for (let i = 0; i < input.length; i++, offset += 2) {
          let s = Math.max(-1, Math.min(1, input[i]));
          s = s < 0 ? s * 0x8000 : s * 0x7fff;
          view.setInt16(offset, s, true);
        }
      }

      async function sendToStt(blob) {
        const input = document.getElementById("chatInput");
        if (input) input.value = "Transcribing...";
        try {
          const fd = new FormData();
          fd.append("file", blob, "recording.wav");
          
          const res = await fetch("/stt", { method: "POST", body: fd });
          const data = await res.json();
          if (res.ok) {
            if (input) {
              input.value = data.text || "";
              input.focus();
            }
          } else {
            if (input) input.value = "";
            showMessage(`STT error: ${data.detail || "Failed to transcribe"}`, "error");
          }
        } catch (e) {
          console.error("STT request failed:", e);
          if (input) input.value = "";
          showMessage("STT failed. Please try again.", "error");
        }
      }

             function logout() {
         sessionStorage.removeItem("user");
         setTimeout(() => {
           window.location.href = "/";
         }, 1000);
       }

                   function showMessage(message, type) {
        // Show both error and success messages
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";
        
        // Auto-hide success messages after 3 seconds
        if (type === 'success') {
          setTimeout(() => {
            messageDiv.style.display = "none";
          }, 3000);
        }
      }

      // Feedback functions (inline button + form)
      function toggleFeedbackForm(messageId) {
        const form = document.getElementById(`feedback-form-${messageId}`);
        if (!form) return;
        const show = form.style.display !== 'block';
        form.style.display = show ? 'block' : 'none';
      }

      function rateMessage(messageId, rating) {
        const stars = document.getElementById(`star-rating-${messageId}`).children;
        for (let i = 0; i < stars.length; i++) {
          const star = stars[i];
          star.classList.remove('active', 'filled');
          if (i < rating) {
            star.classList.add('active');
            star.classList.add('filled');
          }
        }
      }

      async function submitInlineFeedback(messageId) {
        if (!user || !currentChatId) return;
        const filledStars = document.querySelectorAll(`#star-rating-${messageId} .filled`);
        const commentEl = document.getElementById(`comment-${messageId}`);
        
        if (filledStars.length === 0) {
          showMessage("Please select a rating.", "error");
          return;
        }
        
        const rating = filledStars.length;
        const commentVal = commentEl ? commentEl.value.trim() || null : null;

        try {
          const response = await fetch("/feedbacks", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              chat_id: currentChatId,
              message_id: messageId,
              user_id: user.id,
              rating: rating,
              comment: commentVal
            })
          });
                     if (response.ok) {
             toggleFeedbackForm(messageId);
             if (commentEl) commentEl.value = "";
             // Reset stars
             const stars = document.querySelectorAll(`#star-rating-${messageId} .star`);
             stars.forEach(star => star.classList.remove('active', 'filled'));
           } else {
            const error = await response.json();
            showMessage(`Error: ${error.detail || 'Failed to submit feedback'}`, "error");
          }
        } catch (e) {
          console.error('Feedback submit error', e);
          showMessage("Error submitting feedback. Please try again.", "error");
        }
      }

      // Change Password Modal Functions
      function openChangePasswordModal() {
        document.getElementById('changePasswordModal').classList.add('active');
        document.getElementById('currentPassword').focus();
      }

      function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').classList.remove('active');
        document.getElementById('changePasswordForm').reset();
      }

      // Handle change password form submission
      document.addEventListener('DOMContentLoaded', function() {
        const changePasswordForm = document.getElementById('changePasswordForm');
        if (changePasswordForm) {
          changePasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
              showMessage("New passwords do not match.", "error");
              return;
            }
            
            if (newPassword.length < 6) {
              showMessage("New password must be at least 6 characters long.", "error");
              return;
            }
            
            try {
              const response = await fetch('/change-password', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  current_password: currentPassword,
                  new_password: newPassword
                })
              });
              
              if (response.ok) {
                closeChangePasswordModal();
                showMessage("Password changed successfully!", "success");
              } else {
                const error = await response.json();
                showMessage(`Error: ${error.detail || 'Failed to change password'}`, "error");
              }
            } catch (error) {
              console.error('Change password error:', error);
              showMessage("Error changing password. Please try again.", "error");
            }
          });
        }

        // Close modal when clicking outside
        const modal = document.getElementById('changePasswordModal');
        if (modal) {
          modal.addEventListener('click', function(e) {
            if (e.target === this) {
              closeChangePasswordModal();
            }
          });
        }
      });
      
      document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>
  </body>
</html>