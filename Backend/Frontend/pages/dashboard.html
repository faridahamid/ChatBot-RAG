<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - RAG ChatBot</title>
    <link rel="stylesheet" href="/css/dashboard.css">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="welcome-message">Welcome to Your Dashboard</h1>
        <p>You have successfully logged in!</p>
      </div>

      <div id="message" class="message" style="display: none"></div>

      <div class="user-info">
        <h2>User Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Username:</div>
            <div class="info-value" id="username">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Role:</div>
            <div class="info-value" id="role">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Organization:</div>
            <div class="info-value" id="organization">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">User ID:</div>
            <div class="info-value" id="userid">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Chat Interface for Users -->
      <div class="chat-section" id="chatSection">
        <div class="chat-header">
          <h2> Chat with AI Assistant</h2>
          <button class="new-chat-btn" onclick="createNewChat()">
            New Chat
          </button>
        </div>
        <p style="text-align: center; margin-bottom: 1rem; opacity: 0.8">
          Ask questions about your organization's documents and get intelligent
          answers
        </p>
        
        
        
        <div class="chat-layout">
          <div class="chat-history" id="chatHistory" style="display: none;">
            <h4>Your Chats</h4>
            <div id="chatHistoryList"></div>
          </div>

          <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="message-bubble assistant">
              <div>
                Hello! I'm your AI assistant. I can help you find information
                from your organization's documents. What would you like to know?
              </div>
              <div class="timestamp">Just now</div>
            </div>
          </div>
          <div class="chat-input-container">
            <input
              type="text"
              class="chat-input"
              id="chatInput"
              placeholder="Type your question here..."
              onkeypress="handleKeyPress(event)"
            />
            <button class="mic-btn" id="micBtn" title="Record voice" aria-label="Record voice" onclick="toggleRecording()">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 3a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V6a3 3 0 0 0-3-3z"></path>
                <path d="M19 10a7 7 0 0 1-14 0"></path>
                <path d="M12 17v4"></path>
                <path d="M9 21h6"></path>
              </svg>
            </button>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
              Send
            </button>
          </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" onclick="window.location.href='/'">
          Go to Welcome Page
        </button>
        <button class="btn" onclick="window.location.href='/login'">
          Back to Login
        </button>
        <button
          class="btn admin-btn"
          id="adminActions"
          onclick="window.location.href='/admin-upload'"
          style="display: none"
        >
           Upload Files
        </button>
        <button
          class="btn admin-btn"
          id="adminUserActions"
          onclick="window.location.href='/admin-users'"
          style="display: none"
        >
          üë• Manage Users
        </button>
        <button
          class="btn admin-btn"
          id="adminDocumentActions"
          onclick="window.location.href='/admin-documents'"
          style="display: none"
        >
           Manage Documents
        </button>
        <button class="btn" onclick="window.location.href='/change-password'" style="background: linear-gradient(45deg, #17a2b8, #138496);">üîê Change Password</button>
        <button class="btn logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <script>
      
      let currentChatId = null;
      let user = null;

      
      function loadUserInfo() {
        const userStr = sessionStorage.getItem("user");
        if (userStr) {
          try {
            user = JSON.parse(userStr);
            
            
            if (user.role === "super-admin") {
              window.location.href = "/super-admin";
              return;
            }
            
            document.getElementById("username").textContent =
              user.username || "N/A";
            document.getElementById("role").textContent = user.role || "N/A";
            document.getElementById("organization").textContent =
              user.organization_name || "N/A";
            document.getElementById("userid").textContent = user.id || "N/A";

          
            if (user.role === "admin") {
              document.getElementById("adminActions").style.display =
                "inline-block";
              document.getElementById("adminUserActions").style.display =
                "inline-block";
              document.getElementById("adminDocumentActions").style.display =
                "inline-block";
              
              document.getElementById("chatSection").style.display = "block";
              document.getElementById("chatHistory").style.display = "block";
              loadChatHistory();
            } else {
              
              document.getElementById("chatSection").style.display = "block";
              document.getElementById("chatHistory").style.display = "block";
              
              loadChatHistory();
            }

            showMessage(
              "Welcome back! You are successfully logged in.",
              "success"
            );
          } catch (error) {
            console.error("Error parsing user data:", error);
            showMessage("Error loading user information.", "error");
          }
        } else {
          showMessage(
            "No user information found. Please log in again.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "/login";
          }, 2000);
        }
      }

      
      async function createNewChat() {
        if (!user) {
          showMessage("User not found. Please log in again.", "error");
          return;
        }

        try {
          const response = await fetch("/chats", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: user.id,
            }),
          });

          if (response.ok) {
            const chatData = await response.json();
            currentChatId = chatData.chat_id;
            
            
            clearChatMessages();
            
            // Add welcome message
            addMessage(
              "Hello! I'm your AI assistant. I can help you find information from your organization's documents. What would you like to know?",
              "assistant"
            );
            
            
            loadChatHistory();
            
            showMessage("New chat created!", "success");
          } else {
            const error = await response.json();
            showMessage(`Error creating chat: ${error.detail}`, "error");
          }
        } catch (error) {
          console.error("Error creating new chat:", error);
          showMessage("Error creating new chat.", "error");
        }
      }

      async function loadChatHistory() {
        if (!user) return;

        try {
          const response = await fetch(`/chats/${user.id}`);
          if (response.ok) {
            const chats = await response.json();
            displayChatHistory(chats);
          }
        } catch (error) {
          console.error("Error loading chat history:", error);
        }
      }

      function displayChatHistory(chats) {
        const chatHistory = document.getElementById("chatHistory");
        const chatHistoryList = document.getElementById("chatHistoryList");
        
        chatHistory.style.display = "block";
        chatHistoryList.innerHTML = "";

        if (chats.length === 0) {
          const empty = document.createElement("div");
          empty.className = "chat-item";
          empty.textContent = "No chats yet";
          chatHistoryList.appendChild(empty);
          return;
        }

        chats.forEach(chat => {
          const chatItem = document.createElement("div");
          chatItem.className = `chat-item ${chat.chat_id === currentChatId ? 'active' : ''}`;
          chatItem.onclick = () => loadChat(chat.chat_id);
          chatItem.ondblclick = () => enableRename(chat.chat_id, chat.title);
          
          const title = chat.title || "New Chat";
          const date = new Date(chat.created_at).toLocaleDateString();
          const messageCount = chat.message_count || 0;
          
          chatItem.innerHTML = `
            <div class="chat-title" data-id="${chat.chat_id}">${title}</div>
            <div class="chat-meta">${date} ‚Ä¢ ${messageCount} messages</div>
          `;
          
          chatHistoryList.appendChild(chatItem);
        });
      }

      async function loadChat(chatId) {
        if (!user) return;

        try {
          const response = await fetch(`/chats/${chatId}/messages`);
          if (response.ok) {
            const messages = await response.json();
            currentChatId = chatId;
            
            
            clearChatMessages();
            
            
            messages.forEach(msg => {
              addMessage(msg.content, msg.role, new Date(msg.created_at));
            });
            
            
            loadChatHistory();
            
            requestAnimationFrame(() => {
              const chatMessages = document.getElementById("chatMessages");
              if (chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
            });
          }
        } catch (error) {
          console.error("Error loading chat:", error);
          showMessage("Error loading chat.", "error");
        }
      }

      function clearChatMessages() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
      }

      
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      function addMessage(content, role, timestamp = new Date()) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message-bubble ${role}`;

        const timeStr = timestamp.toLocaleTimeString();
        messageDiv.innerHTML = `
          <div>${content}</div>
          <div class="timestamp">${timeStr}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      
      async function enableRename(chatId, currentTitle) {
        const newTitle = prompt("Rename chat:", currentTitle || "");
        if (newTitle === null) return; 
        const t = newTitle.trim();
        if (!t) return;
        try {
          const res = await fetch(`/chats/${chatId}/title`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: user.id, title: t })
          });
          if (res.ok) {
            
            loadChatHistory(false);
          } else {
            const err = await res.json();
            showMessage(`Rename failed: ${err.detail || 'Unknown error'}`, 'error');
          }
        } catch (e) {
          console.error('Rename error', e);
          showMessage('Rename failed. Please try again.', 'error');
        }
      }

      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendBtn");
        const question = input.value.trim();

        if (!question) return;

        if (!user) {
          showMessage("Session expired. Please log in again.", "error");
          return;
        }

        const orgId = user.organization_id;
        const userId = user.id;

        if (!orgId || !userId) {
          showMessage(
            "Missing user information. Please log in again.",
            "error"
          );
          return;
        }

        
        addMessage(question, "user");

        
        input.value = "";
        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading-indicator";
        loadingDiv.textContent = "AI is thinking...";
        document.getElementById("chatMessages").appendChild(loadingDiv);

        try {
          const requestBody = {
            org_id: orgId,
            user_id: userId,
            question: question,
          };

          
          if (currentChatId) {
            requestBody.chat_id = currentChatId;
          }

          const response = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          const data = await response.json();

         
          loadingDiv.remove();

          if (response.ok) {
            addMessage(data.answer, "assistant");
            
           
            if (!currentChatId) {
              loadChatHistory();
            }
          } else {
            addMessage(
              `Error: ${data.detail || "Failed to get response"}`,
              "assistant"
            );
          }
        } catch (error) {
          console.error("Error sending message:", error);
          loadingDiv.remove();
          addMessage(
            "Sorry, I encountered an error. Please try again.",
            "assistant"
          );
        } finally {
          
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
        }
      }

     
      let isRecording = false;
      let audioContext = null;
      let mediaStream = null;
      let sourceNode = null;
      let processorNode = null;
      let recordedBuffers = [];
      let recordingLength = 0;
      let recordingSampleRate = 16000; 

      async function toggleRecording() {
        const btn = document.getElementById("micBtn");
        if (!isRecording) {
          await startRecording();
          btn.classList.add("recording");
        } else {
          const wavBlob = await stopRecording();
          btn.classList.remove("recording");
          if (wavBlob) {
            await sendToStt(wavBlob);
          }
        }
      }

      async function startRecording() {
        recordedBuffers = [];
        recordingLength = 0;

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaStream = stream;
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        sourceNode = audioContext.createMediaStreamSource(stream);
        
        const bufferSize = 4096;
        processorNode = audioContext.createScriptProcessor(bufferSize, 1, 1);
        recordingSampleRate = audioContext.sampleRate || 44100;
        processorNode.onaudioprocess = (e) => {
          const input = e.inputBuffer.getChannelData(0);
          recordedBuffers.push(new Float32Array(input));
          recordingLength += input.length;
        };
        sourceNode.connect(processorNode);
        processorNode.connect(audioContext.destination);
        isRecording = true;
      }

      async function stopRecording() {
        if (!isRecording) return null;
        isRecording = false;
        try {
          if (processorNode) processorNode.disconnect();
          if (sourceNode) sourceNode.disconnect();
          if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
          if (audioContext && audioContext.state !== "closed") await audioContext.close();
        } catch (e) {
          console.warn("Cleanup error:", e);
        }

        const pcm = mergeBuffers(recordedBuffers, recordingLength);
      
        const pcm16k = resampleLinear(pcm, recordingSampleRate, 16000);
        const wavBlob = encodeWAV(pcm16k, 16000);
        return wavBlob;
      }

      function mergeBuffers(bufferArray, totalLength) {
        const result = new Float32Array(totalLength);
        let offset = 0;
        for (let i = 0; i < bufferArray.length; i++) {
          result.set(bufferArray[i], offset);
          offset += bufferArray[i].length;
        }
        return result;
      }

      function resampleLinear(input, inRate, outRate) {
        if (inRate === outRate) return input;
        const ratio = outRate / inRate;
        const newLength = Math.round(input.length * ratio);
        const output = new Float32Array(newLength);
        for (let i = 0; i < newLength; i++) {
          const pos = i / ratio;
          const idx = Math.floor(pos);
          const frac = pos - idx;
          const v0 = input[idx] || 0;
          const v1 = input[idx + 1] || v0;
          output[i] = v0 + (v1 - v0) * frac;
        }
        return output;
      }

      function encodeWAV(samples, sampleRate) {
    
        const bytesPerSample = 2;
        const blockAlign = 1 * bytesPerSample;
        const byteRate = sampleRate * blockAlign;
        const dataSize = samples.length * bytesPerSample;
        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);

       
        writeString(view, 0, "RIFF");
        view.setUint32(4, 36 + dataSize, true);
        writeString(view, 8, "WAVE");

        
        writeString(view, 12, "fmt ");
        view.setUint32(16, 16, true); 
        view.setUint16(20, 1, true);  
        view.setUint16(22, 1, true);  
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, 16, true); 

        
        writeString(view, 36, "data");
        view.setUint32(40, dataSize, true);

       
        floatTo16BitPCM(view, 44, samples);

        return new Blob([view], { type: "audio/wav" });
      }

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      function floatTo16BitPCM(view, offset, input) {
        for (let i = 0; i < input.length; i++, offset += 2) {
          let s = Math.max(-1, Math.min(1, input[i]));
          s = s < 0 ? s * 0x8000 : s * 0x7fff;
          view.setInt16(offset, s, true);
        }
      }

      async function sendToStt(blob) {
        const input = document.getElementById("chatInput");
        if (input) input.value = "Transcribing...";
        try {
          const fd = new FormData();
          fd.append("file", blob, "recording.wav");
          
          const res = await fetch("/stt", { method: "POST", body: fd });
          const data = await res.json();
          if (res.ok) {
            if (input) {
              input.value = data.text || "";
              input.focus();
            }
          } else {
            if (input) input.value = "";
            showMessage(`STT error: ${data.detail || "Failed to transcribe"}`, "error");
          }
        } catch (e) {
          console.error("STT request failed:", e);
          if (input) input.value = "";
          showMessage("STT failed. Please try again.", "error");
        }
      }

      function logout() {
        sessionStorage.removeItem("user");
        showMessage("Logging out...", "success");
        setTimeout(() => {
          window.location.href = "/";
        }, 1000);
      }

      function showMessage(message, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";
      }

      
      document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>
  </body>
</html>
