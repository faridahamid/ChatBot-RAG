<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - RAG ChatBot</title>
    <link rel="stylesheet" href="/css/dashboard.css">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 class="welcome-message">Welcome to Your Dashboard</h1>
        <p>You have successfully logged in!</p>
      </div>

      <div id="message" class="message" style="display: none"></div>

      <div class="user-info">
        <h2>User Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Username:</div>
            <div class="info-value" id="username">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Role:</div>
            <div class="info-value" id="role">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">Organization:</div>
            <div class="info-value" id="organization">Loading...</div>
          </div>
          <div class="info-item">
            <div class="info-label">User ID:</div>
            <div class="info-value" id="userid">Loading...</div>
          </div>
        </div>
      </div>

      <!-- Chat Interface for Users -->
      <div class="chat-section" id="chatSection">
        <div class="chat-header">
          <h2>üí¨ Chat with AI Assistant</h2>
          <button class="new-chat-btn" onclick="createNewChat()">
            New Chat
          </button>
        </div>
        <p style="text-align: center; margin-bottom: 1rem; opacity: 0.8">
          Ask questions about your organization's documents and get intelligent
          answers
        </p>
        
      
        
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="message-bubble assistant">
              <div>
                Hello! I'm your AI assistant. I can help you find information
                from your organization's documents. What would you like to know?
              </div>
              <div class="timestamp">Just now</div>
            </div>
          </div>
          <div class="chat-input-container">
            <input
              type="text"
              class="chat-input"
              id="chatInput"
              placeholder="Type your question here..."
              onkeypress="handleKeyPress(event)"
            />
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
              Send
            </button>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" onclick="window.location.href='/'">
          Go to Welcome Page
        </button>
        <button class="btn" onclick="window.location.href='/login'">
          Back to Login
        </button>
        <button
          class="btn admin-btn"
          id="adminActions"
          onclick="window.location.href='/admin-upload'"
          style="display: none"
        >
          üìÅ Upload Files
        </button>
        <button
          class="btn admin-btn"
          id="adminUserActions"
          onclick="window.location.href='/admin-users'"
          style="display: none"
        >
          üë• Manage Users
        </button>
        <button class="btn logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <script>
      // Global variables for chat management
      let currentChatId = null;
      let user = null;

      // Load user information from session storage
      function loadUserInfo() {
        const userStr = sessionStorage.getItem("user");
        if (userStr) {
          try {
            user = JSON.parse(userStr);
            
            // Redirect super-admin users to their dashboard
            if (user.role === "super-admin") {
              window.location.href = "/super-admin";
              return;
            }
            
            document.getElementById("username").textContent =
              user.username || "N/A";
            document.getElementById("role").textContent = user.role || "N/A";
            document.getElementById("organization").textContent =
              user.organization_name || "N/A";
            document.getElementById("userid").textContent = user.id || "N/A";

            // Show admin actions if user is admin
            if (user.role === "admin") {
              document.getElementById("adminActions").style.display =
                "inline-block";
              document.getElementById("adminUserActions").style.display =
                "inline-block";
            } else {
              // Show chat interface for regular users
              document.getElementById("chatSection").style.display = "block";
              // Load chat history
              loadChatHistory();
            }

            showMessage(
              "Welcome back! You are successfully logged in.",
              "success"
            );
          } catch (error) {
            console.error("Error parsing user data:", error);
            showMessage("Error loading user information.", "error");
          }
        } else {
          showMessage(
            "No user information found. Please log in again.",
            "error"
          );
          setTimeout(() => {
            window.location.href = "/login";
          }, 2000);
        }
      }

      // Chat management functions
      async function createNewChat() {
        if (!user) {
          showMessage("User not found. Please log in again.", "error");
          return;
        }

        try {
          const response = await fetch("/chats", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              user_id: user.id,
            }),
          });

          if (response.ok) {
            const chatData = await response.json();
            currentChatId = chatData.chat_id;
            
            // Clear chat messages
            clearChatMessages();
            
            // Add welcome message
            addMessage(
              "Hello! I'm your AI assistant. I can help you find information from your organization's documents. What would you like to know?",
              "assistant"
            );
            
            // Refresh chat history
            loadChatHistory();
            
            showMessage("New chat created!", "success");
          } else {
            const error = await response.json();
            showMessage(`Error creating chat: ${error.detail}`, "error");
          }
        } catch (error) {
          console.error("Error creating new chat:", error);
          showMessage("Error creating new chat.", "error");
        }
      }

      async function loadChatHistory() {
        if (!user) return;

        try {
          const response = await fetch(`/chats/${user.id}`);
          if (response.ok) {
            const chats = await response.json();
            displayChatHistory(chats);
          }
        } catch (error) {
          console.error("Error loading chat history:", error);
        }
      }

      function displayChatHistory(chats) {
        const chatHistory = document.getElementById("chatHistory");
        const chatHistoryList = document.getElementById("chatHistoryList");
        
        if (chats.length === 0) {
          chatHistory.style.display = "none";
          return;
        }

        chatHistory.style.display = "block";
        chatHistoryList.innerHTML = "";

        chats.forEach(chat => {
          const chatItem = document.createElement("div");
          chatItem.className = `chat-item ${chat.chat_id === currentChatId ? 'active' : ''}`;
          chatItem.onclick = () => loadChat(chat.chat_id);
          
          const title = chat.title || "New Chat";
          const date = new Date(chat.created_at).toLocaleDateString();
          const messageCount = chat.message_count || 0;
          
          chatItem.innerHTML = `
            <div class="chat-title">${title}</div>
            <div class="chat-meta">${date} ‚Ä¢ ${messageCount} messages</div>
          `;
          
          chatHistoryList.appendChild(chatItem);
        });
      }

      async function loadChat(chatId) {
        if (!user) return;

        try {
          const response = await fetch(`/chats/${chatId}/messages`);
          if (response.ok) {
            const messages = await response.json();
            currentChatId = chatId;
            
            // Clear current messages
            clearChatMessages();
            
            // Load messages
            messages.forEach(msg => {
              addMessage(msg.content, msg.role, new Date(msg.created_at));
            });
            
            // Update chat history display
            loadChatHistory();
          }
        } catch (error) {
          console.error("Error loading chat:", error);
          showMessage("Error loading chat.", "error");
        }
      }

      function clearChatMessages() {
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML = "";
      }

      // Chat functionality
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      function addMessage(content, role, timestamp = new Date()) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message-bubble ${role}`;

        const timeStr = timestamp.toLocaleTimeString();
        messageDiv.innerHTML = `
          <div>${content}</div>
          <div class="timestamp">${timeStr}</div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage() {
        const input = document.getElementById("chatInput");
        const sendBtn = document.getElementById("sendBtn");
        const question = input.value.trim();

        if (!question) return;

        if (!user) {
          showMessage("Session expired. Please log in again.", "error");
          return;
        }

        const orgId = user.organization_id;
        const userId = user.id;

        if (!orgId || !userId) {
          showMessage(
            "Missing user information. Please log in again.",
            "error"
          );
          return;
        }

        // Add user message to chat
        addMessage(question, "user");

        // Clear input and disable send button
        input.value = "";
        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        // Add loading indicator
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading-indicator";
        loadingDiv.textContent = "AI is thinking...";
        document.getElementById("chatMessages").appendChild(loadingDiv);

        try {
          const requestBody = {
            org_id: orgId,
            user_id: userId,
            question: question,
          };

          // Add chat_id if we have a current chat
          if (currentChatId) {
            requestBody.chat_id = currentChatId;
          }

          const response = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestBody),
          });

          const data = await response.json();

          // Remove loading indicator
          loadingDiv.remove();

          if (response.ok) {
            addMessage(data.answer, "assistant");
            
            // If this was a new chat, refresh the history
            if (!currentChatId) {
              loadChatHistory();
            }
          } else {
            addMessage(
              `Error: ${data.detail || "Failed to get response"}`,
              "assistant"
            );
          }
        } catch (error) {
          console.error("Error sending message:", error);
          loadingDiv.remove();
          addMessage(
            "Sorry, I encountered an error. Please try again.",
            "assistant"
          );
        } finally {
          // Re-enable send button
          sendBtn.disabled = false;
          sendBtn.textContent = "Send";
        }
      }

      function logout() {
        sessionStorage.removeItem("user");
        showMessage("Logging out...", "success");
        setTimeout(() => {
          window.location.href = "/";
        }, 1000);
      }

      function showMessage(message, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";
      }

      // Load user info when page loads
      document.addEventListener("DOMContentLoaded", loadUserInfo);
    </script>
  </body>
</html>
